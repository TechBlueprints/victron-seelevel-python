#!/bin/sh
echo "*** starting dbus-seelevel ***"
exec 2>&1
. /etc/profile.d/profile.sh

# Wait for dbus-ble-advertisements service with retry logic
MAX_RETRIES=30
RETRY_DELAY=2
RETRY_COUNT=0

echo "Waiting for dbus-ble-advertisements service..."

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    # Check for both service names (router creates both)
    if dbus-send --system --print-reply --dest=org.freedesktop.DBus /org/freedesktop/DBus org.freedesktop.DBus.ListNames 2>/dev/null | grep -q "com.victronenergy.ble.advertisements"; then
        echo "âœ“ Router service found after $RETRY_COUNT attempts"
        break
    fi
    
    RETRY_COUNT=$((RETRY_COUNT + 1))
    
    if [ $RETRY_COUNT -eq 1 ]; then
        echo "Waiting for dbus-ble-advertisements service to start..."
    elif [ $RETRY_COUNT -eq 15 ]; then
        echo "Still waiting... (${RETRY_COUNT}/${MAX_RETRIES} attempts)"
    fi
    
    sleep $RETRY_DELAY
done

# Final check
if ! dbus-send --system --print-reply --dest=org.freedesktop.DBus /org/freedesktop/DBus org.freedesktop.DBus.ListNames 2>/dev/null | grep -q "com.victronenergy.ble.advertisements"; then
    echo ""
    echo "=========================================="
    echo "ERROR: dbus-ble-advertisements not found!"
    echo "=========================================="
    echo ""
    echo "This service requires the dbus-ble-advertisements router."
    echo ""
    echo "Please install it from:"
    echo "  https://github.com/TechBlueprints/dbus-ble-advertisements"
    echo ""
    echo "Alternative: Use the legacy-standalone-btmon branch:"
    echo "  https://github.com/TechBlueprints/victron-seelevel-python/tree/legacy-standalone-btmon"
    echo ""
    sleep 10  # Brief pause before supervisor restarts
    exit 1
fi

echo "Starting seelevel service..."
cd /data/apps/dbus-seelevel/data
exec softlimit -d 100000000 -s 1000000 -a 100000000 python3 -u /data/apps/dbus-seelevel/data/dbus-seelevel-service.py
